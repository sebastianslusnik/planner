<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NUTU Team Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0e12;--panel:#151a21;--panel2:#10161d;--text:#e9eef5;--muted:#b6c0cd;--border:#232a35;--primary:#00e0a4;--danger:#ff4d5e;--accent:#6ea8fe;--shadow:0 10px 30px rgba(0,0,0,.35)
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:linear-gradient(180deg,#0b0e12 0%, #0a0d11 100%);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
.container{max-width:1200px;margin:0 auto;padding:16px}
.header{position:sticky;top:0;z-index:30;background:rgba(10,13,17,.7);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
.nav{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
h1{font-size:18px;margin:0;font-weight:800}
.btn{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-weight:700;cursor:pointer}
.btn.primary{background:linear-gradient(180deg,#00e0a4,#12b889);border:none}
.btn.danger{background:rgba(255,77,94,.12);border-color:rgba(255,77,94,.4);color:#ff9aa3}
.grid{display:grid;grid-template-columns:1.1fr 1fr;gap:16px;margin-top:16px}
.card{background:linear-gradient(180deg,#11161d,#0e131a);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
.card-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border)}
.card-title{margin:0;font-size:16px;font-weight:800}
.card-body{padding:16px}
.form{display:grid;gap:10px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
label{font-size:12px;color:var(--muted)}
.input, select, textarea{background:#0f141b;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;width:100%}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--border);padding:10px;text-align:left;font-size:13px}
.kv{display:flex;flex-wrap:wrap;gap:8px}
.badge{padding:4px 8px;border-radius:8px;background:#0f141b;border:1px solid var(--border);font-size:12px}
@media(max-width:980px){.grid{grid-template-columns:1fr}.form-row{grid-template-columns:1fr}}
</style>
</head>
<body>
<header class="header">
  <div class="container">
    <div class="nav">
      <h1>NUTU Team Admin</h1>
      <div class="kv">
        <a class="btn" href="index.html">Vissza a főoldalra</a>
        <button class="btn" id="reloadBtn">Frissítés</button>
        <span class="badge">JSONBin szinkron aktív</span>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <section class="grid">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Bejelentések</h3>
        <button class="btn primary" id="addAnnouncement">Új</button>
      </div>
      <div class="card-body">
        <div class="form" id="annList"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Hírek</h3>
        <button class="btn primary" id="addNews">Új</button>
      </div>
      <div class="card-body">
        <div class="form" id="newsList"></div>
      </div>
    </div>
  </section>

  <section class="grid" style="margin-top:16px">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Edzéstípusok</h3>
        <button class="btn primary" id="addType">Új típus</button>
      </div>
      <div class="card-body">
        <div id="types"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Ismétlődő időpontok</h3>
        <button class="btn primary" id="addRecurring">Új ismétlődés</button>
      </div>
      <div class="card-body">
        <div id="recurring"></div>
      </div>
    </div>
  </section>

  <section class="card" style="margin-top:16px">
    <div class="card-header">
      <h3 class="card-title">Foglalások</h3>
      <div>
        <button class="btn" id="exportCSV">Export CSV</button>
      </div>
    </div>
    <div class="card-body">
      <table class="table" id="reservationsTable">
        <thead>
          <tr>
            <th>Dátum</th><th>Idő</th><th>Típus</th><th>Név</th><th>E-mail</th><th>Telefon</th><th>Megjegyzés</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<div id="modalRoot"></div>

<script>
const JSONBIN_MASTER = "$2a$10$9sO/ja29sMebpWNvsWmp5.dJ6lv7CPeLBMRFaA/cAEwz42ii6qlCS"
const BINS = {
  announcements: "68b5536243b1c97be932d1ed",
  reservations: "68b5535343b1c97be932d1e1",
  news: "68b5531fd0ea881f406dbd52",
  calendar: "68b55123d0ea881f406dbb52"
}
const api = {
  async get(id){
    const r = await fetch(`https://api.jsonbin.io/v3/b/${id}/latest`,{headers:{'X-Master-Key':JSONBIN_MASTER,'Content-Type':'application/json','X-Bin-Meta':'false'}})
    if(!r.ok) throw new Error('Hálózati hiba')
    return r.json()
  },
  async put(id, body){
    const r = await fetch(`https://api.jsonbin.io/v3/b/${id}`,{method:'PUT',headers:{'X-Master-Key':JSONBIN_MASTER,'Content-Type':'application/json'},body:JSON.stringify(body)})
    if(!r.ok) throw new Error('Mentési hiba')
    return r.json()
  }
}
const state = {announcements:[],news:[],calendar:null,reservations:[]}
function el(tag, attrs={}, ...children){const e=document.createElement(tag);Object.entries(attrs).forEach(([k,v])=>{if(k==='class') e.className=v; else if(k==='style') e.setAttribute('style',v); else if(k.startsWith('on')) e.addEventListener(k.slice(2),v); else e.setAttribute(k,v)});children.forEach(c=>{if(c==null)return; if(typeof c==='string') e.appendChild(document.createTextNode(c)); else e.appendChild(c)});return e}
function input(value, placeholder){const i=document.createElement('input');i.className='input';i.value=value||'';if(placeholder)i.placeholder=placeholder;return i}
function select(options, value){const s=document.createElement('select');s.className='input';options.forEach(o=>{const op=document.createElement('option');op.value=o.value;op.textContent=o.label; if(o.value===value) op.selected=true; s.appendChild(op)});return s}
function textarea(value){const t=document.createElement('textarea');t.className='input';t.rows=3;t.value=value||'';return t}
function uid(){return crypto.randomUUID()}

async function loadAll(){
  const [ann, news, cal, res] = await Promise.all([api.get(BINS.announcements), api.get(BINS.news), api.get(BINS.calendar), api.get(BINS.reservations)])
  state.announcements=ann||[]
  state.news=news||[]
  state.calendar=cal||{trainingTypes:[],recurring:[]}
  state.reservations=res||[]
  renderAnnouncements()
  renderNews()
  renderTypes()
  renderRecurring()
  renderReservations()
}

function renderAnnouncements(){
  const root=document.getElementById('annList')
  root.innerHTML=''
  state.announcements.forEach(a=>{
    const title=input(a.title,'Cím')
    const content=textarea(a.content)
    const type=select([{value:'info',label:'Info'},{value:'danger',label:'Danger'},{value:'warning',label:'Warning'}], a.type||'info')
    const expires=input(a.expiresAt||'','Lejárat (YYYY-MM-DD)')
    const active=select([{value:'true',label:'Aktív'},{value:'false',label:'Inaktív'}], String(a.active!==false))
    const save=el('button',{class:'btn primary',onclick:async()=>{Object.assign(a,{title:title.value,content:content.value,type:type.value,expiresAt:expires.value,active:active.value==='true'});await api.put(BINS.announcements,[...state.announcements]);loadAll()}},'Mentés')
    const del=el('button',{class:'btn danger',onclick:async()=>{state.announcements=state.announcements.filter(x=>x.id!==a.id);await api.put(BINS.announcements,state.announcements);loadAll()}},'Törlés')
    root.appendChild(el('div',{class:'card',style:'padding:12px;margin-bottom:10px'},
      el('div',{class:'form'},
        el('div',{class:'form-row'}, el('div',{},el('label',{},'Cím'),title), el('div',{},el('label',{},'Típus'),type)),
        el('div',{},el('label',{},'Tartalom'),content),
        el('div',{class:'form-row'}, el('div',{},el('label',{},'Lejárat'),expires), el('div',{},el('label',{},'Állapot'),active)),
        el('div',{}, save, el('span',{style:'margin-left:8px'}), del)
      )
    ))
  })
}
document.getElementById('addAnnouncement').onclick=async()=>{
  state.announcements.unshift({id:uid(),title:'Új bejelentés',content:'',type:'info',active:true})
  await api.put(BINS.announcements,state.announcements)
  loadAll()
}

function renderNews(){
  const root=document.getElementById('newsList')
  root.innerHTML=''
  state.news.forEach(n=>{
    const title=input(n.title,'Cím')
    const image=input(n.image||'','Kép URL (opcionális)')
    const content=textarea(n.content)
    const date=input(n.date||'','Dátum (YYYY-MM-DD)')
    const save=el('button',{class:'btn primary',onclick:async()=>{Object.assign(n,{title:title.value,image:image.value||null,content:content.value,date:date.value});await api.put(BINS.news,[...state.news]);loadAll()}},'Mentés')
    const del=el('button',{class:'btn danger',onclick:async()=>{state.news=state.news.filter(x=>x.id!==n.id);await api.put(BINS.news,state.news);loadAll()}},'Törlés')
    root.appendChild(el('div',{class:'card',style:'padding:12px;margin-bottom:10px'},
      el('div',{class:'form'},
        el('div',{class:'form-row'}, el('div',{},el('label',{},'Cím'),title), el('div',{},el('label',{},'Dátum'),date)),
        el('div',{},el('label',{},'Kép URL'),image),
        el('div',{},el('label',{},'Tartalom'),content),
        el('div',{},save, el('span',{style:'margin-left:8px'}), del)
      )
    ))
  })
}
document.getElementById('addNews').onclick=async()=>{
  state.news.unshift({id:uid(),title:'Új hír',image:null,content:'',date:new Date().toISOString().slice(0,10)})
  await api.put(BINS.news,state.news)
  loadAll()
}

function renderTypes(){
  const root=document.getElementById('types')
  root.innerHTML=''
  const wrapper=el('div',{})
  ;(state.calendar.trainingTypes||[]).forEach(t=>{
    const name=input(t.name,'Név')
    const level=input(t.level,'Szint')
    const desc=input(t.description,'Leírás')
    const loc=input(t.location,'Helyszín')
    const color=input(t.color,'Szín (hex)')
    const capacity=input(String(t.capacity||12),'Kapacitás')
    const duration=input(String(t.duration||60),'Időtartam (perc)')
    const save=el('button',{class:'btn primary',onclick:async()=>{Object.assign(t,{name:name.value,level:level.value,description:desc.value,location:loc.value,color:color.value,capacity:Number(capacity.value||12),duration:Number(duration.value||60)});await api.put(BINS.calendar,state.calendar);loadAll()}},'Mentés')
    const del=el('button',{class:'btn danger',onclick:async()=>{state.calendar.trainingTypes=state.calendar.trainingTypes.filter(x=>x.id!==t.id);state.calendar.recurring=state.calendar.recurring.filter(r=>r.trainingTypeId!==t.id);await api.put(BINS.calendar,state.calendar);loadAll()}},'Törlés')
    wrapper.appendChild(el('div',{class:'card',style:'padding:12px;margin-bottom:10px'},
      el('div',{class:'form'},
        el('div',{class:'form-row'}, el('div',{},el('label',{},'Név'),name), el('div',{},el('label',{},'Szint'),level)),
        el('div',{class:'form-row'}, el('div',{},el('label',{},'Szín'),color), el('div',{},el('label',{},'Helyszín'),loc)),
        el('div',{class:'form-row'}, el('div',{},el('label',{},'Kapacitás'),capacity), el('div',{},el('label',{},'Időtartam'),duration)),
        el('div',{},el('label',{},'Leírás'),desc),
        el('div',{},save, el('span',{style:'margin-left:8px'}), del)
      )
    ))
  })
  root.appendChild(wrapper)
}
document.getElementById('addType').onclick=async()=>{
  const t={id:uid(),name:'Új típus',level:'Kezdő',description:'',location:'Moson',color:'#6ea8fe',capacity:12,duration:60}
  state.calendar.trainingTypes.push(t)
  await api.put(BINS.calendar,state.calendar)
  loadAll()
}

function renderRecurring(){
  const root=document.getElementById('recurring')
  root.innerHTML=''
  const days=[{v:1,l:'Hétfő'},{v:2,l:'Kedd'},{v:3,l:'Szerda'},{v:4,l:'Csütörtök'},{v:5,l:'Péntek'},{v:6,l:'Szombat'},{v:7,l:'Vasárnap'}]
  ;(state.calendar.recurring||[]).forEach(r=>{
    const typeSel=select((state.calendar.trainingTypes||[]).map(t=>({value:t.id,label:`${t.name} • ${t.level}`})), r.trainingTypeId)
    const daySel=select(days.map(d=>({value:String(d.v),label:d.l})), String(r.weekday))
    const time=input(r.time,'Idő (HH:MM)')
    const loc=input(r.location||'','Helyszín (opcionális)')
    const cap=input(String(r.capacity||''),'Kapacitás (opcionális)')
    const save=el('button',{class:'btn primary',onclick:async()=>{Object.assign(r,{trainingTypeId:typeSel.value,weekday:Number(daySel.value),time:time.value,location:loc.value||null,capacity:cap.value?Number(cap.value):null});await api.put(BINS.calendar,state.calendar);loadAll()}},'Mentés')
    const del=el('button',{class:'btn danger',onclick:async()=>{state.calendar.recurring=state.calendar.recurring.filter(x=>x.id!==r.id);await api.put(BINS.calendar,state.calendar);loadAll()}},'Törlés')
    root.appendChild(el('div',{class:'card',style:'padding:12px;margin-bottom:10px'},
      el('div',{class:'form'},
        el('div',{class:'form-row'}, el('div',{},el('label',{},'Edzéstípus'),typeSel), el('div',{},el('label',{},'Nap'),daySel)),
        el('div',{class:'form-row'}, el('div',{},el('label',{},'Idő'),time), el('div',{},el('label',{},'Kapacitás'),cap)),
        el('div',{},el('label',{},'Helyszín'),loc),
        el('div',{},save, el('span',{style:'margin-left:8px'}), del)
      )
    ))
  })
}
document.getElementById('addRecurring').onclick=async()=>{
  const firstType=state.calendar.trainingTypes[0]
  if(!firstType){alert('Előbb hozz létre edzéstípust');return}
  state.calendar.recurring.push({id:uid(),trainingTypeId:firstType.id,weekday:1,time:'17:00',location:null,capacity:null})
  await api.put(BINS.calendar,state.calendar)
  loadAll()
}

function renderReservations(){
  const tbody=document.querySelector('#reservationsTable tbody')
  tbody.innerHTML=''
  const typeName=id=> (state.calendar.trainingTypes||[]).find(t=>t.id===id)?.name || 'Ismeretlen'
  state.reservations.sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time)).forEach(r=>{
    const tr=document.createElement('tr')
    tr.appendChild(el('td',{},r.date))
    tr.appendChild(el('td',{},r.time))
    tr.appendChild(el('td',{},typeName(r.trainingTypeId)))
    tr.appendChild(el('td',{},r.name))
    tr.appendChild(el('td',{},r.email))
    tr.appendChild(el('td',{},r.phone||''))
    tr.appendChild(el('td',{},r.note||''))
    tr.appendChild(el('td',{}, el('button',{class:'btn danger',onclick:()=>confirmDelete(r.id)},'Törlés')))
    tbody.appendChild(tr)
  })
}

async function confirmDelete(id){
  if(!confirm('Biztosan törlöd a foglalást?')) return
  state.reservations=state.reservations.filter(r=>r.id!==id)
  await api.put(BINS.reservations, state.reservations)
  renderReservations()
}

document.getElementById('exportCSV').onclick=()=>{
  const rows=[['Dátum','Idő','Típus','Név','E-mail','Telefon','Megjegyzés']]
  const types=state.calendar.trainingTypes||[]
  const typeName=id=> types.find(t=>t.id===id)?.name || ''
  state.reservations.forEach(r=>{
    rows.push([r.date,r.time,typeName(r.trainingTypeId),r.name,r.email,r.phone||'',r.note||''])
  })
  const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n')
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'})
  const url=URL.createObjectURL(blob)
  const a=document.createElement('a')
  a.href=url;a.download='foglalasok.csv';a.click()
  URL.revokeObjectURL(url)
}

document.getElementById('reloadBtn').onclick=()=>loadAll()
loadAll().catch(()=>{})
</script>
</body>
</html>
