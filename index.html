<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pilates Mosonmagyaróvár</title>
<meta name="description" content="Pilates edzések Mosonmagyaróváron. Foglalj időpontot, nézd meg az órarendet, árakat, híreket és különleges csomagokat.">
<link rel="preconnect" href="https://api.jsonbin.io">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b0f14;--card:#121821;--muted:#8aa0b2;--text:#e9f0f6;--acc:#7be0b8;--acc2:#ff6b6b;--acc3:#7cb7ff;--ring:rgba(123,224,184,.45)}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:linear-gradient(180deg,#0b0f14 0%,#0b1118 60%,#0a0e14 100%);color:var(--text);font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
img{max-width:100%;display:block}
a{color:inherit;text-decoration:none}
button{font:inherit}
.container{max-width:1100px;margin:0 auto;padding:16px}
.section{padding:28px 0}
.card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.hero{position:relative;overflow:hidden}
.hero::before{content:"";position:absolute;inset:-40% -10% auto -10%;height:80vh;background:radial-gradient(800px 400px at 50% 0,rgba(123,224,184,.18),transparent 60%),radial-gradient(600px 300px at 10% 20%,rgba(124,183,255,.18),transparent 60%);filter:blur(30px);pointer-events:none}
.nav{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 14px;border-radius:14px}
.brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px}
.brand-dot{width:12px;height:12px;border-radius:50%;background:linear-gradient(45deg,var(--acc),#57cda1)}
.nav a{opacity:.9}
.nav a:hover{opacity:1}
.announcements{display:flex;gap:10px;overflow:auto;padding:10px 6px}
.badge{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.1);display:flex;align-items:center;gap:8px;white-space:nowrap}
.badge.danger{background:rgba(255,107,107,.1);border-color:rgba(255,107,107,.3)}
.badge.info{background:rgba(124,183,255,.1);border-color:rgba(124,183,255,.3)}
.badge.success{background:rgba(123,224,184,.12);border-color:rgba(123,224,184,.35)}
.hero-grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}
.hero-cta{padding:22px}
.h1{font-size:34px;line-height:1.1;margin:0 0 8px}
.p{color:var(--muted);margin:0 0 16px}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.btn{padding:12px 16px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--text)}
.btn.primary{background:linear-gradient(180deg,rgba(123,224,184,.25),rgba(123,224,184,.12));border-color:rgba(123,224,184,.5)}
.btn.danger{background:linear-gradient(180deg,rgba(255,107,107,.22),rgba(255,107,107,.08));border-color:rgba(255,107,107,.5)}
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.kpi{padding:16px;text-align:center}
.kpi strong{display:block;font-size:22px}
.section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.section-title h2{font-size:22px;margin:0}
.grid{display:grid;gap:12px}
.grid.cols-2{grid-template-columns:1fr 1fr}
.grid.cols-3{grid-template-columns:1fr 1fr 1fr}
@media (min-width:760px){
.hero-grid{grid-template-columns:1.3fr .7fr}
.grid.cols-3{grid-template-columns:repeat(3,1fr)}
}
.card-title{font-weight:700;margin:0 0 6px}
.muted{color:var(--muted)}
.tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:12px}
.flex{display:flex;gap:8px;align-items:center}
.row{display:flex;gap:8px;flex-wrap:wrap}
.gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.gallery img{border-radius:10px;height:100%;object-fit:cover;aspect-ratio:1/1}
.price-card{padding:16px}
.price{font-size:26px;font-weight:800}
.list{display:grid;gap:8px;margin:10px 0}
.list .li{display:flex;gap:10px;align-items:flex-start}
.separator{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.tab{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.08);cursor:pointer;background:rgba(255,255,255,.04)}
.tab.active{border-color:rgba(123,224,184,.5);background:rgba(123,224,184,.12)}
.calendar{display:grid;gap:10px}
.cal-nav{display:flex;align-items:center;justify-content:space-between}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cal-cell{padding:10px;border-radius:10px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);min-height:88px;display:flex;flex-direction:column;gap:6px}
.cal-cell .date{font-size:12px;color:var(--muted)}
.event{border-radius:8px;padding:6px 8px;font-size:12px;color:#00120b}
.event .cap{font-weight:700}
.legend{display:flex;gap:8px;flex-wrap:wrap}
.legend .item{display:flex;align-items:center;gap:6px}
.dot{width:10px;height:10px;border-radius:50%}
.list-view{display:grid;gap:8px}
.list-item{display:flex;justify-content:space-between;gap:10px;padding:10px;border-radius:12px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06)}
.form{display:grid;gap:10px}
.input{display:grid;gap:6px}
.input input,.input select,.input textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--text);outline:none}
.input input:focus,.input select:focus,.input textarea:focus{border-color:var(--acc);box-shadow:0 0 0 4px var(--ring)}
.map{height:220px;border-radius:14px;overflow:hidden;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);position:relative}
.map iframe{position:absolute;inset:0;width:100%;height:100%;filter:grayscale(100%) contrast(1.1) brightness(.9)}
.footer{padding:18px;text-align:center;color:var(--muted)}
.toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0d131a;border:1px solid rgba(255,255,255,.12);padding:12px 14px;border-radius:12px;display:none}
.hidden{display:none}
.badge .x{opacity:.7}
hr.sep{border:0;border-top:1px solid rgba(255,255,255,.08);margin:8px 0}
</style>
</head>
<body>
<div class="container hero section">
  <div class="card nav">
    <div class="brand"><span class="brand-dot"></span><span>Pilates Mosonmagyaróvár</span></div>
    <div class="row">
      <a href="#edzesek" class="tag">Edzések</a>
      <a href="#galeria" class="tag">Galéria</a>
      <a href="#arak" class="tag">Árak</a>
      <a href="#orarend" class="tag">Órarend</a>
      <a href="#hir" class="tag">Hírek</a>
      <a href="#rolam" class="tag">Rólam</a>
      <a href="#kapcsolat" class="tag">Kapcsolat</a>
    </div>
  </div>

  <div id="announceBar" class="announcements section"></div>

  <div class="hero-grid">
    <div class="card hero-cta">
      <h1 class="h1">Pilates edzések Mosonmagyaróváron</h1>
      <p class="p">Erősíts, nyújts, kapcsolódj. Kiscsoportos órák limitált férőhellyel, több szinten, barátságos közegben.</p>
      <div class="actions">
        <a href="#orarend" class="btn primary">Időpontok és foglalás</a>
        <a href="#arak" class="btn">Árak és csomagok</a>
      </div>
      <div class="separator"></div>
      <div class="kpis">
        <div class="kpi"><strong id="kpiTrainings">0</strong><span class="muted">Heti foglalkozás</span></div>
        <div class="kpi"><strong id="kpiTypes">0</strong><span class="muted">Edzéstípus</span></div>
        <div class="kpi"><strong id="kpiSpots">0</strong><span class="muted">Szabad hely ma</span></div>
      </div>
    </div>
    <div class="card" style="padding:6px;">
      <div class="gallery" style="grid-template-columns:1fr 1fr;gap:6px;">
        <img src="https://images.unsplash.com/photo-1552196563-55cd4e45efb3?q=80&w=800&auto=format&fit=crop" alt="Pilates 1">
        <img src="https://images.unsplash.com/photo-1599050751795-5f9d5f60cba6?q=80&w=800&auto=format&fit=crop" alt="Pilates 2">
        <img src="https://images.unsplash.com/photo-1549570652-97324981a6fd?q=80&w=800&auto=format&fit=crop" alt="Pilates 3">
        <img src="https://images.unsplash.com/photo-1518611012118-696072aa579a?q=80&w=800&auto=format&fit=crop" alt="Pilates 4">
      </div>
    </div>
  </div>
</div>

<div id="edzesek" class="container section">
  <div class="section-title">
    <h2>Edzések és szintek</h2>
    <div class="legend" id="legend"></div>
  </div>
  <div id="trainingTypes" class="grid cols-2"></div>
</div>

<div id="galeria" class="container section">
  <div class="section-title"><h2>Galéria</h2></div>
  <div class="card" style="padding:10px;">
    <div class="gallery">
      <img src="https://images.unsplash.com/photo-1552196560-5a58007b2f89?q=80&w=600&auto=format&fit=crop" alt="">
      <img src="https://images.unsplash.com/photo-1575052814086-f385e2e2ad1b?q=80&w=600&auto=format&fit=crop" alt="">
      <img src="https://images.unsplash.com/photo-1518310952931-b1de897abd40?q=80&w=600&auto=format&fit=crop" alt="">
      <img src="https://images.unsplash.com/photo-1571019614242-c5c5dee9f50b?q=80&w=600&auto=format&fit=crop" alt="">
      <img src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?q=80&w=600&auto=format&fit=crop" alt="">
      <img src="https://images.unsplash.com/photo-1571731268624-2741a3fc42cd?q=80&w=600&auto=format&fit=crop" alt="">
    </div>
  </div>
</div>

<div id="arak" class="container section">
  <div class="section-title"><h2>Árak és csomagok</h2></div>
  <div class="grid cols-3" id="pricing">
    <div class="card price-card">
      <div class="tag">Alkalmi</div>
      <div class="price">3 500 Ft</div>
      <div class="muted">1 alkalom, érvényes: 1 hét</div>
      <div class="list">
        <div class="li"><span class="tag">Kiscsoport</span><span class="muted">max. létszám</span></div>
        <div class="li"><span class="tag">Foglalás</span><span class="muted">rugalmas</span></div>
      </div>
      <a href="#orarend" class="btn primary">Foglalok</a>
    </div>
    <div class="card price-card">
      <div class="tag">Bérlet</div>
      <div class="price">12 000 Ft</div>
      <div class="muted">4 alkalom, érvényes: 5 hét</div>
      <div class="list">
        <div class="li"><span class="tag">Elsőbbség</span><span class="muted">foglalásnál</span></div>
        <div class="li"><span class="tag">Rugalmasság</span><span class="muted">módosítás</span></div>
      </div>
      <a href="#orarend" class="btn primary">Foglalok</a>
    </div>
    <div class="card price-card">
      <div class="tag">Privát</div>
      <div class="price">7 500 Ft</div>
      <div class="muted">1 fő / 60 perc</div>
      <div class="list">
        <div class="li"><span class="tag">Személyre szabott</span></div>
        <div class="li"><span class="tag">Rugalmas időpont</span></div>
      </div>
      <a href="#kontakt" class="btn">Kapcsolat</a>
    </div>
  </div>
</div>

<div id="orarend" class="container section">
  <div class="section-title">
    <h2>Órarend és foglalás</h2>
    <div class="tabs">
      <button class="tab active" data-view="calendar">Naptár nézet</button>
      <button class="tab" data-view="list">Lista nézet</button>
    </div>
  </div>
  <div class="card" style="padding:14px;">
    <div class="calendar">
      <div class="cal-nav">
        <div class="row">
          <button id="prevMonth" class="btn">Előző</button>
          <button id="todayBtn" class="btn">Ma</button>
          <button id="nextMonth" class="btn">Következő</button>
        </div>
        <div id="calLabel" class="tag"></div>
      </div>
      <div class="cal-grid" id="calGrid"></div>
      <div class="separator"></div>
      <div class="list-view hidden" id="listView"></div>
    </div>
  </div>
  <div class="section" style="padding-top:18px;">
    <div class="card" style="padding:14px;">
      <div class="section-title"><h2>Foglalás</h2></div>
      <form id="bookingForm" class="form">
        <div class="grid cols-2">
          <div class="input"><label>Edzéstípus</label><select id="bfType"></select></div>
          <div class="input"><label>Dátum</label><input id="bfDate" type="date"></div>
        </div>
        <div class="grid cols-2">
          <div class="input"><label>Időpont</label><select id="bfTime"></select></div>
          <div class="input"><label>Férőhely</label><input id="bfCapacity" type="text" disabled></div>
        </div>
        <div class="grid cols-2">
          <div class="input"><label>Név</label><input id="bfName" type="text" required></div>
          <div class="input"><label>E-mail</label><input id="bfEmail" type="email" required></div>
        </div>
        <div class="input"><label>Telefon</label><input id="bfPhone" type="tel"></div>
        <div class="input"><label>Megjegyzés</label><textarea id="bfNote" rows="3"></textarea></div>
        <button class="btn primary" type="submit">Foglalás elküldése</button>
        <div id="bookingInfo" class="muted"></div>
      </form>
    </div>
  </div>
</div>

<div id="hir" class="container section">
  <div class="section-title"><h2>Hírek</h2></div>
  <div id="newsList" class="grid"></div>
</div>

<div id="rolam" class="container section">
  <div class="section-title"><h2>Rólam</h2></div>
  <div class="card" style="padding:16px;">
    <div class="row" style="align-items:center;">
      <img src="https://images.unsplash.com/photo-1594824476967-48c8b9642732?q=80&w=240&auto=format&fit=crop" alt="Edző" style="width:96px;height:96px;border-radius:16px;object-fit:cover;">
      <div>
        <div class="card-title">Pilates oktató</div>
        <div class="muted">Lélegzet, tartás, erő, fókusz. Több éves tapasztalattal segítek a fájdalommentes, erős és rugalmas test elérésében, barátságos, támogató légkörben.</div>
      </div>
    </div>
    <hr class="sep">
    <div class="grid cols-2">
      <div class="tag">Kezdő és haladó csoportok</div>
      <div class="tag">Korlátozott létszám</div>
      <div class="tag">Mosonmagyaróvár központ</div>
      <div class="tag">Privát órák kérésre</div>
    </div>
  </div>
</div>

<div id="kapcsolat" class="container section">
  <div class="section-title"><h2>Kapcsolat</h2></div>
  <div class="grid cols-2">
    <div class="card" style="padding:14px;">
      <div class="list">
        <div class="li"><span class="tag">Cím</span><div>Mosonmagyaróvár, Magyarország</div></div>
        <div class="li"><span class="tag">E-mail</span><a href="mailto:info@pilates-movar.hu">info@pilates-movar.hu</a></div>
        <div class="li"><span class="tag">Telefon</span><a href="tel:+36301234567">+36 30 123 4567</a></div>
        <div class="li"><span class="tag">Közösség</span><div class="row"><a class="tag" href="#">Facebook</a><a class="tag" href="#">Instagram</a></div></div>
      </div>
    </div>
    <div class="map card">
      <iframe title="Térkép" src="https://www.openstreetmap.org/export/embed.html?bbox=17.249%2C47.843%2C17.300%2C47.886&layer=mapnik&marker=47.867%2C17.274"></iframe>
    </div>
  </div>
</div>

<div class="container section">
  <div class="footer card">
    <div>Hivatkozások: <a href="#orarend">Órarend</a> • <a href="#arak">Árak</a> • <a href="#hir">Hírek</a></div>
    <div class="muted" style="margin-top:6px;">© <span id="year"></span> Pilates Mosonmagyaróvár</div>
    <div class="muted" style="margin-top:6px;"><a class="tag" href="admin.html">Admin</a></div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const JSONBIN_KEY="$2a$10$9sO/ja29sMebpWNvsWmp5.dJ6lv7CPeLBMRFaA/cAEwz42ii6qlCS";
const BIN_ANN="68b5536243b1c97be932d1ed";
const BIN_RES="68b5535343b1c97be932d1e1";
const BIN_NEWS="68b5531fd0ea881f406dbd52";
const BIN_CAL="68b55123d0ea881f406dbb52";

const api={
  get:async(id)=>{const r=await fetch("https://api.jsonbin.io/v3/b/"+id,{headers:{"X-Master-Key":JSONBIN_KEY}});if(!r.ok)throw new Error("Hiba letöltéskor");const j=await r.json();return j.record},
  put:async(id,data)=>{const r=await fetch("https://api.jsonbin.io/v3/b/"+id,{method:"PUT",headers:{"Content-Type":"application/json","X-Master-Key":JSONBIN_KEY},body:JSON.stringify(data)});if(!r.ok)throw new Error("Hiba mentéskor");return r.json()}
};

const el=(q)=>document.querySelector(q);
const els=(q)=>document.querySelectorAll(q);
const toast=(m)=>{const t=el("#toast");t.textContent=m;t.style.display="block";setTimeout(()=>t.style.display="none",2200)};

const state={calendar:null,reservations:[],news:[],announcements:[],view:"calendar",today:new Date()};
const fmt2=(n)=>String(n).padStart(2,"0");
const ymd=(d)=>d.getFullYear()+"-"+fmt2(d.getMonth()+1)+"-"+fmt2(d.getDate());
const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x};
const weekdayHu=["V","H","K","Sze","Cs","P","Szo"];

async function loadAll(){
  const [cal,res,news,ann]=await Promise.all([api.get(BIN_CAL),api.get(BIN_RES),api.get(BIN_NEWS),api.get(BIN_ANN)]);
  state.calendar=cal;
  state.reservations=res;
  state.news=news;
  state.announcements=ann;
  renderAll();
}

function renderAnnouncements(){
  const wrap=el("#announceBar");wrap.innerHTML="";
  const now=new Date();
  state.announcements.filter(a=>a.active!==false && (!a.expiresAt || new Date(a.expiresAt)>=now)).forEach(a=>{
    const b=document.createElement("div");
    b.className="badge "+(a.type==="danger"?"danger":a.type==="info"?"info":"success");
    b.innerHTML='<strong>'+a.title+'</strong><span class="x">'+a.content+'</span>';
    wrap.appendChild(b);
  });
}

function renderTrainingTypes(){
  const cont=el("#trainingTypes");cont.innerHTML="";
  const legend=el("#legend");legend.innerHTML="";
  state.calendar.trainingTypes.forEach(t=>{
    const card=document.createElement("div");
    card.className="card";
    card.style.padding="14px";
    card.innerHTML='<div class="row" style="justify-content:space-between;"><div class="card-title">'+t.name+' <span class="muted">• '+t.level+'</span></div><span class="tag"><span class="dot" style="background:'+t.color+'"></span>'+t.capacity+' fő</span></div><div class="muted" style="margin-top:6px;">'+(t.description||"")+'</div><div class="row" style="margin-top:10px;"><span class="tag">Helyszín: '+(t.location||"")+'</span><span class="tag">Időtartam: '+(t.duration||60)+' perc</span></div>';
    cont.appendChild(card);
    const li=document.createElement("div");
    li.className="item";
    li.innerHTML='<span class="dot" style="background:'+t.color+'"></span><span>'+t.name+'</span>';
    legend.appendChild(li);
  });
}

function expandRecurring(monthDate){
  const start=new Date(monthDate.getFullYear(),monthDate.getMonth(),1);
  const end=new Date(monthDate.getFullYear(),monthDate.getMonth()+1,0);
  const events=[];
  const byType=Object.fromEntries(state.calendar.trainingTypes.map(t=>[t.id,t]));
  state.calendar.recurring.forEach(r=>{
    let d=new Date(start);
    while(d<=end){
      if(d.getDay()===r.weekday){events.push({id:r.id+"_"+ymd(d),trainingTypeId:r.trainingTypeId,date:ymd(d),time:r.time,location:r.location,capacity:r.capacity});}
      d=addDays(d,1);
    }
  });
  events.sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  return {events,byType};
}

function capacityLeft(trainingTypeId,date,time){
  const t=state.calendar.trainingTypes.find(x=>x.id===trainingTypeId);
  const base=t?Number(t.capacity||0):0;
  const extraCap=0;
  const cap=extraCap||base;
  const taken=state.reservations.filter(r=>r.trainingTypeId===trainingTypeId && r.date===date && r.time===time).length;
  return Math.max(0,cap-taken);
}

function renderCalendar(monthDate){
  const grid=el("#calGrid");grid.innerHTML="";
  const label=el("#calLabel");
  const monthNames=["Január","Február","Március","Április","Május","Június","Július","Augusztus","Szeptember","Október","November","December"];
  label.textContent=monthNames[monthDate.getMonth()]+" "+monthDate.getFullYear();
  const {events,byType}=expandRecurring(monthDate);
  const first=new Date(monthDate.getFullYear(),monthDate.getMonth(),1);
  const offset=(first.getDay()+6)%7;
  for(let i=0;i<7;i++){const head=document.createElement("div");head.className="muted";head.style.textAlign="center";head.textContent=["H","K","Sze","Cs","P","Szo","V"][i];grid.appendChild(head)}
  let daysInMonth=new Date(monthDate.getFullYear(),monthDate.getMonth()+1,0).getDate();
  for(let i=0;i<offset;i++){const d=document.createElement("div");d.className="cal-cell";d.style.opacity=".35";grid.appendChild(d)}
  for(let day=1;day<=daysInMonth;day++){
    const cell=document.createElement("div");cell.className="cal-cell";
    const dstr=ymd(new Date(monthDate.getFullYear(),monthDate.getMonth(),day));
    const header=document.createElement("div");header.className="date";header.textContent=day+".";
    cell.appendChild(header);
    events.filter(e=>e.date===dstr).forEach(e=>{
      const t=byType[e.trainingTypeId];
      if(!t)return;
      const left=capacityLeft(e.trainingTypeId,e.date,e.time);
      const ev=document.createElement("div");
      ev.className="event";
      ev.style.background=t.color;
      ev.innerHTML='<div class="cap">'+t.name+' • '+e.time+'</div><div style="font-size:11px">'+(left>0?left+" szabad hely":"Betelt")+'</div>';
      ev.style.cursor="pointer";
      ev.onclick=()=>preselectBooking(t.id,e.date,e.time,left);
      cell.appendChild(ev);
    });
    grid.appendChild(cell);
  }
  updateKPIs(monthDate,events);
  renderListView(events);
}

function updateKPIs(monthDate,events){
  const weekStart=addDays(new Date(),-((new Date().getDay()+6)%7));
  const weekEnd=addDays(weekStart,6);
  const weekStr=[ymd(weekStart),ymd(weekEnd)];
  const weekly=events.filter(e=>e.date>=weekStr[0]&&e.date<=weekStr[1]).length;
  el("#kpiTrainings").textContent=weekly;
  el("#kpiTypes").textContent=state.calendar.trainingTypes.length;
  const todayStr=ymd(new Date());
  const todayEvents=events.filter(e=>e.date===todayStr);
  let free=0;todayEvents.forEach(e=>free+=capacityLeft(e.trainingTypeId,e.date,e.time));
  el("#kpiSpots").textContent=free;
}

function renderListView(events){
  const wrap=el("#listView");wrap.innerHTML="";
  const byType=Object.fromEntries(state.calendar.trainingTypes.map(t=>[t.id,t]));
  const upcoming=events.filter(e=>new Date(e.date+"T"+e.time+":00")>=addDays(new Date(),-1)).slice(0,40);
  upcoming.forEach(e=>{
    const t=byType[e.trainingTypeId];
    const left=capacityLeft(e.trainingTypeId,e.date,e.time);
    const row=document.createElement("div");
    row.className="list-item";
    row.innerHTML='<div><div class="card-title">'+t.name+' • '+e.time+'</div><div class="muted">'+e.date+' • '+(t.location||"")+'</div></div><div class="row"><div class="tag">'+(left>0?left+" hely":"Betelt")+'</div><button class="btn '+(left>0?'primary':'danger')+'" '+(left>0?'':'disabled')+'>Foglalás</button></div>';
    row.querySelector("button").onclick=()=>preselectBooking(t.id,e.date,e.time,left);
    wrap.appendChild(row);
  });
}

function renderNews(){
  const cont=el("#newsList");cont.innerHTML="";
  state.news.sort((a,b)=>b.date.localeCompare(a.date)).forEach(n=>{
    const card=document.createElement("div");card.className="card";card.style.padding="14px";
    card.innerHTML='<div class="row" style="justify-content:space-between;"><div class="card-title">'+n.title+'</div><div class="muted">'+n.date+'</div></div><div class="muted" style="margin-top:6px;">'+n.content+'</div>';
    cont.appendChild(card);
  });
}

function fillBookingSelectors(){
  const selType=el("#bfType");selType.innerHTML="";
  state.calendar.trainingTypes.forEach(t=>{
    const o=document.createElement("option");o.value=t.id;o.textContent=t.name+" • "+t.level;selType.appendChild(o);
  });
  el("#bfDate").value=ymd(new Date());
  populateTimes();
}

function populateTimes(){
  const typeId=el("#bfType").value;
  const date=el("#bfDate").value;
  const weekday=new Date(date).getDay();
  const times=[...state.calendar.recurring.filter(r=>r.trainingTypeId===typeId && r.weekday===weekday).map(r=>r.time)];
  const sel=el("#bfTime");sel.innerHTML="";
  times.forEach(t=>{const o=document.createElement("option");o.value=t;o.textContent=t;sel.appendChild(o)});
  updateCapPreview();
}

function preselectBooking(typeId,date,time,left){
  el("#bfType").value=typeId;
  el("#bfDate").value=date;
  populateTimes();
  if(time){el("#bfTime").value=time}
  updateCapPreview();
  toast(left>0?"Foglalás előkészítve: "+date+" "+time:"Az esemény betelt");
  location.hash="#orarend";
}

function updateCapPreview(){
  const typeId=el("#bfType").value;
  const date=el("#bfDate").value;
  const time=el("#bfTime").value;
  if(!typeId||!date||!time){el("#bfCapacity").value="";return}
  const left=capacityLeft(typeId,date,time);
  el("#bfCapacity").value=left>0?(left+" szabad hely"):"Betelt";
  el("#bookingInfo").textContent=left>0?"":"Figyelem: nincs szabad hely erre az időpontra.";
}

async function submitBooking(e){
  e.preventDefault();
  const trainingTypeId=el("#bfType").value;
  const date=el("#bfDate").value;
  const time=el("#bfTime").value;
  const name=el("#bfName").value.trim();
  const email=el("#bfEmail").value.trim();
  const phone=el("#bfPhone").value.trim();
  const note=el("#bfNote").value.trim();
  if(!trainingTypeId||!date||!time||!name||!email){toast("Kérjük, töltsd ki a kötelező mezőket.");return}
  const left=capacityLeft(trainingTypeId,date,time);
  if(left<=0){toast("Sajnos betelt. Válassz másik időpontot.");return}
  const reservation={id=crypto.randomUUID?crypto.randomUUID():String(Date.now()),trainingTypeId,date,time,name,email,phone,note,createdAt:new Date().toISOString()};
  const list=[...state.reservations,reservation];
  try{await api.put(BIN_RES,list);state.reservations=list;toast("Foglalás sikeres!");updateCapPreview();renderCalendar(currentMonth)}catch(err){toast("Hiba történt a foglalás mentésekor.");}
}

let currentMonth=new Date(new Date().getFullYear(),new Date().getMonth(),1);

function bindUI(){
  els(".tab").forEach(b=>b.addEventListener("click",()=>{
    els(".tab").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    state.view=b.dataset.view;
    if(state.view==="calendar"){el("#calGrid").classList.remove("hidden");el("#listView").classList.add("hidden")}else{el("#calGrid").classList.add("hidden");el("#listView").classList.remove("hidden")}
  }));
  el("#prevMonth").onclick=()=>{currentMonth=new Date(currentMonth.getFullYear(),currentMonth.getMonth()-1,1);renderCalendar(currentMonth)};
  el("#nextMonth").onclick=()=>{currentMonth=new Date(currentMonth.getFullYear(),currentMonth.getMonth()+1,1);renderCalendar(currentMonth)};
  el("#todayBtn").onclick=()=>{currentMonth=new Date(new Date().getFullYear(),new Date().getMonth(),1);renderCalendar(currentMonth)};
  el("#bfType").onchange=populateTimes;
  el("#bfDate").onchange=populateTimes;
  el("#bfTime").onchange=updateCapPreview;
  el("#bookingForm").addEventListener("submit",submitBooking);
  el("#year").textContent=new Date().getFullYear();
}

function renderAll(){
  renderAnnouncements();
  renderTrainingTypes();
  fillBookingSelectors();
  renderCalendar(currentMonth);
  renderNews();
}

bindUI();
loadAll().catch(()=>toast("Hálózati hiba. Próbáld újra."));
</script>
</body>
</html>
