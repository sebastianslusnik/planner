<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#0b0d10">
<title>Admin • Kick-box Edző</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b0d10;--card:#121722;--muted:#98a3b9;--text:#eef3ff;--accent:#e11d2e;--ok:#22c55e;--warn:#f59e0b;--danger:#ef4444}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
a{color:inherit;text-decoration:none}
.container{max-width:1100px;margin:0 auto;padding:0 16px}
.header{position:sticky;top:0;z-index:20;background:#0c1017;border-bottom:1px solid #1a2233}
.header-inner{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
.brand{display:flex;align-items:center;gap:10px}
.brand .logo{width:34px;height:34px;border-radius:8px;background:radial-gradient(100px 100px at 40% 25%,#2b3144,transparent 70%);display:grid;place-items:center;border:1px solid #2a3040}
.brand .logo span{font-family:Oswald,sans-serif;font-weight:700;color:#d4af37}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 10px;border-radius:10px;border:1px solid #263046;background:#0d131e;color:#dfe6f7;cursor:pointer}
.tab.active{background:var(--accent);border-color:transparent}
.section{padding:18px 0}
.panel{background:var(--card);border:1px solid #212a3d;border-radius:16px;padding:14px;margin-bottom:16px}
.panel h3{margin:0 0 10px;font-family:Oswald,sans-serif;letter-spacing:.4px}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.input{display:grid;gap:6px}
.input input,.input select,.input textarea{width:100%;padding:12px;background:#0b0f16;border:1px solid #273049;border-radius:10px;color:#eef3ff}
.btn{display:inline-flex;align-items:center;justify-content:center;border:none;background:var(--accent);color:#fff;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
.btn.alt{background:#141b29;border:1px solid #263047}
.btn.warn{background:var(--warn)}
.btn.danger{background:var(--danger)}
.list{display:grid;gap:10px}
.item{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;border:1px solid #1f283a;background:#0d131e;border-radius:12px;padding:10px}
.item small{color:var(--muted)}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#182033;border:1px solid #263044;color:#dfe6fb;font-size:12px}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0e131b;border:1px solid #273049;color:#e9efff;padding:10px 14px;border-radius:10px;display:none;z-index:120}
@media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<header class="header">
<div class="container header-inner">
<div class="brand">
<div class="logo"><span>KB</span></div>
<div><strong>Admin</strong> • Kick-box</div>
</div>
<nav class="tabs">
<button class="tab active" data-tab="ann">Közlemények</button>
<button class="tab" data-tab="news">Hírek</button>
<button class="tab" data-tab="cal">Naptár</button>
<button class="tab" data-tab="res">Foglalások</button>
</nav>
</div>
</header>

<main class="container section">
<section id="tab-ann" class="panel">
<h3>Közlemények kezelése</h3>
<div class="grid">
<div class="panel">
<form id="annForm" class="grid">
<div class="input"><label>Cím</label><input type="text" id="annTitle" required></div>
<div class="input"><label>Szöveg</label><textarea id="annContent" rows="3" required></textarea></div>
<div class="row">
<div class="input"><label>Típus</label><select id="annType"><option value="info">Info</option><option value="warning">Figyelmeztetés</option><option value="danger">Fontos</option></select></div>
<div class="input"><label>Lejárat (opcionális)</label><input type="date" id="annExp"></div>
</div>
<div class="row">
<div class="input"><label>Aktív</label><select id="annActive"><option value="true">Igen</option><option value="false">Nem</option></select></div>
<div class="input"><label>Azonosító</label><input type="text" id="annId" readonly placeholder="Mentés után generálódik"></div>
</div>
<div>
<button class="btn" type="submit" id="annSave">Mentés</button>
<button class="btn alt" type="button" id="annReset">Űrlap törlése</button>
</div>
</form>
</div>
<div class="panel">
<div class="list" id="annList"></div>
</div>
</div>
</section>

<section id="tab-news" class="panel" style="display:none">
<h3>Hírek kezelése</h3>
<div class="grid">
<div class="panel">
<form id="newsForm" class="grid">
<div class="input"><label>Cím</label><input type="text" id="newsTitle" required></div>
<div class="input"><label>Kép URL</label><input type="url" id="newsImage" placeholder="https://..."></div>
<div class="input"><label>Tartalom</label><textarea id="newsContent" rows="4" required></textarea></div>
<div class="row">
<div class="input"><label>Dátum</label><input type="date" id="newsDate"></div>
<div class="input"><label>Azonosító</label><input type="text" id="newsId" readonly></div>
</div>
<div>
<button class="btn" type="submit" id="newsSave">Mentés</button>
<button class="btn alt" type="button" id="newsReset">Űrlap törlése</button>
</div>
</form>
</div>
<div class="panel">
<div class="list" id="newsList"></div>
</div>
</div>
</section>

<section id="tab-cal" class="panel" style="display:none">
<h3>Naptár • Képzéstípusok és visszatérő edzések</h3>
<div class="grid">
<div class="panel">
<h4 style="margin:0 0 10px">Képzéstípus</h4>
<form id="typeForm" class="grid">
<div class="input"><label>Név</label><input id="typeName" required></div>
<div class="input"><label>Szint</label><select id="typeLevel"><option>Kezdő</option><option>Nyílt</option><option>Haladó</option></select></div>
<div class="input"><label>Leírás</label><textarea id="typeDesc" rows="3"></textarea></div>
<div class="row">
<div class="input"><label>Alap helyszín</label><input id="typeLoc"></div>
<div class="input"><label>Szín</label><input id="typeColor" type="color" value="#e11d2e"></div>
</div>
<div class="row">
<div class="input"><label>Kapacitás</label><input id="typeCap" type="number" min="1" value="12" required></div>
<div class="input"><label>Időtartam (perc)</label><input id="typeDur" type="number" min="15" value="60" required></div>
</div>
<div class="row">
<div class="input"><label>Azonosító</label><input id="typeId" readonly></div>
</div>
<div>
<button class="btn" type="submit">Mentés</button>
<button class="btn alt" type="button" id="typeReset">Űrlap törlése</button>
</div>
</form>
</div>
<div class="panel">
<h4 style="margin:0 0 10px">Visszatérő edzés</h4>
<form id="recForm" class="grid">
<div class="row">
<div class="input"><label>Képzéstípus</label><select id="recType"></select></div>
<div class="input"><label>Hét napja</label><select id="recWeekday"><option value="1">Hétfő</option><option value="2">Kedd</option><option value="3">Szerda</option><option value="4">Csütörtök</option><option value="5">Péntek</option><option value="6">Szombat</option><option value="7">Vasárnap</option></select></div>
</div>
<div class="row">
<div class="input"><label>Időpont</label><input type="time" id="recTime" required></div>
<div class="input"><label>Helyszín (opcionális)</label><input id="recLoc"></div>
</div>
<div class="row">
<div class="input"><label>Kapacitás felülírás (opcionális)</label><input id="recCap" type="number" min="1"></div>
<div class="input"><label>Azonosító</label><input id="recId" readonly></div>
</div>
<div>
<button class="btn" type="submit">Mentés</button>
<button class="btn alt" type="button" id="recReset">Űrlap törlése</button>
</div>
</form>
</div>
</div>
<div class="panel">
<h4 style="margin:0 0 10px">Jelenlegi beállítások</h4>
<div class="grid">
<div>
<div style="margin-bottom:6px;font-weight:700">Képzéstípusok</div>
<div id="typesList" class="list"></div>
</div>
<div>
<div style="margin-bottom:6px;font-weight:700">Visszatérő edzések</div>
<div id="recsList" class="list"></div>
</div>
</div>
</div>
<div class="panel">
<h4 style="margin:0 0 10px">Előnézet (következő 4 hét)</h4>
<div id="previewList" class="list"></div>
</div>
</section>

<section id="tab-res" class="panel" style="display:none">
<h3>Foglalások</h3>
<div class="grid">
<div class="panel">
<form id="resForm" class="grid">
<div class="row">
<div class="input"><label>Dátum</label><input type="date" id="resDate" required></div>
<div class="input"><label>Idő</label><input type="time" id="resTime" required></div>
</div>
<div class="row">
<div class="input"><label>Képzéstípus</label><select id="resType"></select></div>
<div class="input"><label>Teljes név</label><input id="resName" required></div>
</div>
<div class="row">
<div class="input"><label>E-mail</label><input id="resEmail" type="email" required></div>
<div class="input"><label>Telefon</label><input id="resPhone" required></div>
</div>
<div class="input"><label>Megjegyzés</label><input id="resNote"></div>
<div>
<button class="btn" type="submit">Foglalás hozzáadása</button>
</div>
</form>
</div>
<div class="panel">
<div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
<div class="badge" id="resCount">0 foglalás</div>
<button class="btn alt" id="resReload">Frissítés</button>
</div>
<div id="resList" class="list"></div>
</div>
</div>
</section>
</main>

<div class="toast" id="toast"></div>

<script>
const JSONBIN_KEY="$2a$10$9sO/ja29sMebpWNvsWmp5.dJ6lv7CPeLBMRFaA/cAEwz42ii6qlCS";
const BINS={ann:"68b5536243b1c97be932d1ed",res:"68b5535343b1c97be932d1e1",news:"68b5531fd0ea881f406dbd52",cal:"68b55123d0ea881f406dbb52"};
let data={announcements:[],news:[],calendar:{trainingTypes:[],recurring:[]},reservations:[]};
function toast(m){const t=document.getElementById("toast");t.textContent=m;t.style.display="block";setTimeout(()=>t.style.display="none",2400)}
function uid(){if(crypto&&crypto.randomUUID){return crypto.randomUUID()}return "id-"+Date.now()+"-"+Math.floor(Math.random()*1e6)}
async function getBin(id){try{const r=await fetch("https://api.jsonbin.io/v3/b/"+id+"/latest",{headers:{"X-Master-Key":JSONBIN_KEY}});if(!r.ok)throw new Error("get "+id);const j=await r.json();return j.record}catch(e){return null}}
async function putBin(id,rec){const r=await fetch("https://api.jsonbin.io/v3/b/"+id,{method:"PUT",headers:{"Content-Type":"application/json","X-Master-Key":JSONBIN_KEY},body:JSON.stringify(rec)});if(!r.ok)throw new Error("put "+id)}
function jsDayFromIso(w){if(w===0)return 0;return w%7}
function localWeekdayFromDateStr(s){const [y,m,d]=s.split("-").map(Number);return new Date(y,m-1,d).getDay()}
function fmtLocalISO(d){const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,"0");const da=String(d.getDate()).padStart(2,"0");return y+"-"+m+"-"+da}
async function loadAll(){const [ann,news,cal,res]=await Promise.all([getBin(BINS.ann),getBin(BINS.news),getBin(BINS.cal),getBin(BINS.res)]);data.announcements=Array.isArray(ann)?ann:[];data.news=Array.isArray(news)?news:[];data.calendar=cal&&cal.trainingTypes?cal:{trainingTypes:[],recurring:[]};data.reservations=Array.isArray(res)?res:[];renderAll()}
function renderAll(){renderAnn();renderNews();renderCal();renderRes();fillTypeSelects()}
function setActiveTab(id){document.querySelectorAll(".tab").forEach(t=>{t.classList.toggle("active",t.dataset.tab===id)});document.querySelectorAll("main section.panel").forEach(s=>{s.style.display=s.id==="tab-"+id?"block":"none"})}
document.querySelectorAll(".tab").forEach(b=>b.addEventListener("click",()=>setActiveTab(b.dataset.tab)));
function renderAnn(){const list=document.getElementById("annList");list.innerHTML="";if(data.announcements.length===0){list.innerHTML='<div class="item"><div>Nincs közlemény</div></div>';return}data.announcements.sort((a,b)=>((b.active?1:0)-(a.active?1:0))||new Date(a.expiresAt||"2999-12-31")-new Date(b.expiresAt||"2999-12-31"));data.announcements.forEach(a=>{const it=document.createElement("div");it.className="item";it.innerHTML='<div><div><strong>'+a.title+'</strong> '+(a.type==="warning"?"• Figyelmeztetés":a.type==="danger"?"• Fontos":"• Info")+'</div><small>'+(a.content||"")+'</small><div>'+((a.active!==false)?'<span class="badge">Aktív</span>':'<span class="badge">Inaktív</span>')+(a.expiresAt?(' <small> • lejár: '+a.expiresAt+"</small>"):"")+'</div></div><div style="display:flex;gap:6px"><button class="btn alt" data-edit="'+a.id+'">Szerkeszt</button><button class="btn danger" data-del="'+a.id+'">Töröl</button></div>';list.appendChild(it)});list.querySelectorAll("button[data-edit]").forEach(b=>b.addEventListener("click",()=>loadAnnToForm(b.getAttribute("data-edit"))));list.querySelectorAll("button[data-del]").forEach(b=>b.addEventListener("click",()=>deleteAnn(b.getAttribute("data-del"))))}
function loadAnnToForm(id){const a=data.announcements.find(x=>x.id===id);if(!a)return;document.getElementById("annTitle").value=a.title||"";document.getElementById("annContent").value=a.content||"";document.getElementById("annType").value=a.type||"info";document.getElementById("annExp").value=a.expiresAt?String(a.expiresAt).slice(0,10):"";document.getElementById("annActive").value=String(a.active!==false);document.getElementById("annId").value=a.id}
async function deleteAnn(id){data.announcements=data.announcements.filter(x=>x.id!==id);await putBin(BINS.ann,data.announcements);renderAnn();toast("Közlemény törölve")}
document.getElementById("annForm").addEventListener("submit",async e=>{e.preventDefault();const item={id:document.getElementById("annId").value||uid(),title:document.getElementById("annTitle").value.trim(),content:document.getElementById("annContent").value.trim(),type:document.getElementById("annType").value,expiresAt:document.getElementById("annExp").value||null,active:document.getElementById("annActive").value==="true"};if(!item.title||!item.content){toast("Hiányzó mezők");return}const idx=data.announcements.findIndex(x=>x.id===item.id);if(idx>=0){data.announcements[idx]=item}else{data.announcements.push(item)}await putBin(BINS.ann,data.announcements);renderAnn();document.getElementById("annId").value=item.id;toast("Közlemény mentve")});
document.getElementById("annReset").addEventListener("click",()=>{document.getElementById("annForm").reset();document.getElementById("annId").value=""});
function renderNews(){const list=document.getElementById("newsList");list.innerHTML="";if(data.news.length===0){list.innerHTML='<div class="item"><div>Nincs hír</div></div>';return}data.news.sort((a,b)=>new Date(b.date)-new Date(a.date));data.news.forEach(n=>{const it=document.createElement("div");it.className="item";it.innerHTML='<div><div><strong>'+n.title+'</strong></div><small>'+new Date(n.date||Date.now()).toLocaleDateString("hu-HU")+'</small><div>'+n.content+'</div></div><div style="display:flex;gap:6px"><button class="btn alt" data-edit="'+n.id+'">Szerkeszt</button><button class="btn danger" data-del="'+n.id+'">Töröl</button></div>';list.appendChild(it)});list.querySelectorAll("button[data-edit]").forEach(b=>b.addEventListener("click",()=>loadNewsToForm(b.getAttribute("data-edit"))));list.querySelectorAll("button[data-del]").forEach(b=>b.addEventListener("click",()=>deleteNews(b.getAttribute("data-del"))))}
function loadNewsToForm(id){const n=data.news.find(x=>x.id===id);if(!n)return;document.getElementById("newsTitle").value=n.title||"";document.getElementById("newsImage").value=n.image||"";document.getElementById("newsContent").value=n.content||"";document.getElementById("newsDate").value=n.date?String(n.date).slice(0,10):"";document.getElementById("newsId").value=n.id}
async function deleteNews(id){data.news=data.news.filter(x=>x.id!==id);await putBin(BINS.news,data.news);renderNews();toast("Hír törölve")}
document.getElementById("newsForm").addEventListener("submit",async e=>{e.preventDefault();const item={id:document.getElementById("newsId").value||uid(),title:document.getElementById("newsTitle").value.trim(),image:document.getElementById("newsImage").value.trim()||null,content:document.getElementById("newsContent").value.trim(),date:document.getElementById("newsDate").value||new Date().toISOString().slice(0,10)};if(!item.title||!item.content){toast("Hiányzó mezők");return}const idx=data.news.findIndex(x=>x.id===item.id);if(idx>=0){data.news[idx]=item}else{data.news.push(item)}await putBin(BINS.news,data.news);renderNews();document.getElementById("newsId").value=item.id;toast("Hír mentve")});
document.getElementById("newsReset").addEventListener("click",()=>{document.getElementById("newsForm").reset();document.getElementById("newsId").value=""});
function renderCal(){renderTypes();renderRecs();renderPreview()}
function renderTypes(){const list=document.getElementById("typesList");list.innerHTML="";if(data.calendar.trainingTypes.length===0){list.innerHTML='<div class="item"><div>Nincs típus</div></div>';return}data.calendar.trainingTypes.forEach(t=>{const it=document.createElement("div");it.className="item";it.innerHTML='<div><div><strong>'+t.name+'</strong> • '+(t.level||"")+'</div><small>'+t.description+'</small><div><span class="badge" style="background:'+t.color+';border-color:transparent;color:#000">szín</span> <span class="badge">'+(t.location||"")+'</span> <span class="badge">kapacitás: '+t.capacity+'</span> <span class="badge">'+t.duration+' perc</span> <small>id: '+t.id+'</small></div></div><div style="display:flex;gap:6px"><button class="btn alt" data-edit="'+t.id+'">Szerkeszt</button><button class="btn danger" data-del="'+t.id+'">Töröl</button></div>';list.appendChild(it)});list.querySelectorAll("button[data-edit]").forEach(b=>b.addEventListener("click",()=>loadTypeToForm(b.getAttribute("data-edit"))));list.querySelectorAll("button[data-del]").forEach(b=>b.addEventListener("click",()=>deleteType(b.getAttribute("data-del"))))}
function loadTypeToForm(id){const t=data.calendar.trainingTypes.find(x=>x.id===id);if(!t)return;document.getElementById("typeId").value=t.id;document.getElementById("typeName").value=t.name||"";document.getElementById("typeLevel").value=t.level||"Nyílt";document.getElementById("typeDesc").value=t.description||"";document.getElementById("typeLoc").value=t.location||"";document.getElementById("typeColor").value=t.color||"#e11d2e";document.getElementById("typeCap").value=t.capacity||12;document.getElementById("typeDur").value=t.duration||60}
async function deleteType(id){const used=data.calendar.recurring.some(r=>jsDayFromIso(r.weekday)!==undefined&&r.trainingTypeId===id);if(used){toast("A típus használatban van a visszatérő edzéseknél");return}data.calendar.trainingTypes=data.calendar.trainingTypes.filter(t=>t.id!==id);await putBin(BINS.cal,data.calendar);renderCal();toast("Típus törölve")}
document.getElementById("typeForm").addEventListener("submit",async e=>{e.preventDefault();const t={id:document.getElementById("typeId").value||uid(),name:document.getElementById("typeName").value.trim(),level:document.getElementById("typeLevel").value,description:document.getElementById("typeDesc").value.trim(),location:document.getElementById("typeLoc").value.trim(),color:document.getElementById("typeColor").value,capacity:parseInt(document.getElementById("typeCap").value,10)||12,duration:parseInt(document.getElementById("typeDur").value,10)||60};if(!t.name){toast("Hiányzó mezők");return}const idx=data.calendar.trainingTypes.findIndex(x=>x.id===t.id);if(idx>=0){data.calendar.trainingTypes[idx]=t}else{data.calendar.trainingTypes.push(t)}await putBin(BINS.cal,data.calendar);renderCal();document.getElementById("typeId").value=t.id;fillTypeSelects();toast("Típus mentve")});
document.getElementById("typeReset").addEventListener("click",()=>{document.getElementById("typeForm").reset();document.getElementById("typeId").value=""});
function renderRecs(){const list=document.getElementById("recsList");list.innerHTML="";if(data.calendar.recurring.length===0){list.innerHTML='<div class="item"><div>Nincs visszatérő edzés</div></div>';return}const dayName=["Vasárnap","Hétfő","Kedd","Szerda","Csütörtök","Péntek","Szombat"];data.calendar.recurring.sort((a,b)=>(jsDayFromIso(a.weekday)-jsDayFromIso(b.weekday))||a.time.localeCompare(b.time));data.calendar.recurring.forEach(r=>{const t=data.calendar.trainingTypes.find(x=>x.id===r.trainingTypeId);const dn=dayName[jsDayFromIso(r.weekday)];const it=document.createElement("div");it.className="item";it.innerHTML='<div><div><strong>'+(t?t.name:"?")+'</strong> • '+dn+' • '+r.time+'</div><div><span class="badge">'+(r.location||t?.location||"")+'</span> '+(r.capacity?('<span class="badge">kapacitás: '+r.capacity+'</span>'):"")+' <small>id: '+r.id+'</small></div></div><div style="display:flex;gap:6px"><button class="btn alt" data-edit="'+r.id+'">Szerkeszt</button><button class="btn danger" data-del="'+r.id+'">Töröl</button></div>';list.appendChild(it)});list.querySelectorAll("button[data-edit]").forEach(b=>b.addEventListener("click",()=>loadRecToForm(b.getAttribute("data-edit"))));list.querySelectorAll("button[data-del]").forEach(b=>b.addEventListener("click",()=>deleteRec(b.getAttribute("data-del"))))}
function loadRecToForm(id){const r=data.calendar.recurring.find(x=>x.id===id);if(!r)return;const val=r.weekday===0?7:r.weekday;document.getElementById("recId").value=r.id;document.getElementById("recType").value=r.trainingTypeId;document.getElementById("recWeekday").value=String(val);document.getElementById("recTime").value=r.time;document.getElementById("recLoc").value=r.location||"";document.getElementById("recCap").value=r.capacity||""}
async function deleteRec(id){data.calendar.recurring=data.calendar.recurring.filter(x=>x.id!==id);await putBin(BINS.cal,data.calendar);renderCal();toast("Visszatérő edzés törölve")}
document.getElementById("recForm").addEventListener("submit",async e=>{e.preventDefault();if(data.calendar.trainingTypes.length===0){toast("Előbb hozz létre képzéstípust");return}const wdIso=parseInt(document.getElementById("recWeekday").value,10);const r={id:document.getElementById("recId").value||uid(),trainingTypeId:document.getElementById("recType").value,weekday:wdIso,time:document.getElementById("recTime").value,location:document.getElementById("recLoc").value.trim()||null,capacity:document.getElementById("recCap").value?parseInt(document.getElementById("recCap").value,10):null};if(!r.trainingTypeId||!r.time||Number.isNaN(wdIso)){toast("Hiányzó mezők");return}const idx=data.calendar.recurring.findIndex(x=>x.id===r.id);if(idx>=0){data.calendar.recurring[idx]=r}else{data.calendar.recurring.push(r)}await putBin(BINS.cal,data.calendar);renderCal();document.getElementById("recId").value=r.id;toast("Visszatérő edzés mentve")});
document.getElementById("recReset").addEventListener("click",()=>{document.getElementById("recForm").reset();document.getElementById("recId").value=""});
function fillTypeSelects(){const opts=data.calendar.trainingTypes.map(t=>'<option value="'+t.id+'">'+t.name+'</option>').join("");["recType","resType"].forEach(id=>{const el=document.getElementById(id);if(el){el.innerHTML=opts}})}
function genSessions(days=28){const from=new Date();from.setHours(0,0,0,0);const to=new Date(from);to.setDate(to.getDate()+days);const out=[];for(const r of data.calendar.recurring){let cur=new Date(from);while(cur<=to){if(cur.getDay()===jsDayFromIso(r.weekday)){const dstr=fmtLocalISO(cur);out.push({id:"s-"+r.id+"-"+dstr,trainingTypeId:r.trainingTypeId,date:dstr,time:r.time,location:r.location||null,capacity:r.capacity||null});cur.setDate(cur.getDate()+7)}else{cur.setDate(cur.getDate()+1)}}}out.sort((a,b)=>new Date(a.date+"T"+a.time)-new Date(b.date+"T"+b.time));return out}
function renderPreview(){const list=document.getElementById("previewList");list.innerHTML="";const s=genSessions(28);if(s.length===0){list.innerHTML='<div class="item"><div>Nincs előnézeti időpont</div></div>';return}s.forEach(x=>{const t=data.calendar.trainingTypes.find(k=>k.id===x.trainingTypeId);const cap=x.capacity||t?.capacity||"";const occ=data.reservations.filter(r=>r.trainingTypeId===x.trainingTypeId&&r.date===x.date&&r.time===x.time).length;const free=Math.max(0,(cap||0)-occ);const it=document.createElement("div");it.className="item";it.innerHTML='<div><div><strong>'+x.date+' '+x.time+'</strong> • '+(t?t.name:"?")+'</div><small>'+(x.location||t?.location||"")+'</small></div><div><span class="badge">'+occ+'/'+(cap||"-")+' foglalt</span> '+(cap?('<span class="badge">'+(free>0?('Szabad: '+free):'Betelt')+'</span>'):"")+'</div>';list.appendChild(it)})}
function renderRes(){document.getElementById("resCount").textContent=String(data.reservations.length)+" foglalás";const list=document.getElementById("resList");list.innerHTML="";if(data.reservations.length===0){list.innerHTML='<div class="item"><div>Nincs foglalás</div></div>';return}const sorted=[...data.reservations].sort((a,b)=>new Date(b.createdAt||b.date)-new Date(a.createdAt||a.date));sorted.forEach(r=>{const t=data.calendar.trainingTypes.find(k=>k.id===r.trainingTypeId);const it=document.createElement("div");it.className="item";it.innerHTML='<div><div><strong>'+r.name+'</strong> • '+(r.email||"")+' • '+(r.phone||"")+'</div><small>'+r.date+' '+r.time+' • '+(t?t.name:"?")+'</small><div><small>ID: '+r.id+'</small></div></div><div style="display:flex;gap:6px"><button class="btn danger" data-del="'+r.id+'">Töröl</button></div>';list.appendChild(it)});list.querySelectorAll("button[data-del]").forEach(b=>b.addEventListener("click",()=>deleteRes(b.getAttribute("data-del"))))}
async function deleteRes(id){data.reservations=data.reservations.filter(x=>x.id!==id);await putBin(BINS.res,data.reservations);renderRes();renderPreview();toast("Foglalás törölve")}
document.getElementById("resReload").addEventListener("click",async()=>{const latest=await getBin(BINS.res);data.reservations=Array.isArray(latest)?latest:[];renderRes();renderPreview();toast("Foglalások frissítve")});
document.getElementById("resForm").addEventListener("submit",async e=>{e.preventDefault();const rec={id:uid(),trainingTypeId:document.getElementById("resType").value,date:document.getElementById("resDate").value,time:document.getElementById("resTime").value,name:document.getElementById("resName").value.trim(),email:document.getElementById("resEmail").value.trim(),phone:document.getElementById("resPhone").value.trim(),note:document.getElementById("resNote").value.trim(),createdAt:new Date().toISOString()};if(!rec.trainingTypeId||!rec.date||!rec.time||!rec.name){toast("Hiányzó mezők");return}const t=data.calendar.trainingTypes.find(k=>k.id===rec.trainingTypeId);const dw=localWeekdayFromDateStr(rec.date);const rmatch=data.calendar.recurring.find(r=>jsDayFromIso(r.weekday)===dw&&r.trainingTypeId===rec.trainingTypeId&&r.time===rec.time);const cap=rmatch?.capacity||t?.capacity||null;if(cap){const count=data.reservations.filter(x=>x.trainingTypeId===rec.trainingTypeId&&x.date===rec.date&&x.time===rec.time).length;if(count>=cap){toast("Ez az időpont betelt");return}}const latest=await getBin(BINS.res);data.reservations=Array.isArray(latest)?latest:[];const updated=[...data.reservations,rec];await putBin(BINS.res,updated);data.reservations=updated;renderRes();renderPreview();toast("Foglalás hozzáadva")});
function onTypeChangeSync(){fillTypeSelects()}
document.getElementById("typeForm").addEventListener("change",onTypeChangeSync);
function setup(){setActiveTab("ann");loadAll()}
setup();
</script>
</body>
</html>
